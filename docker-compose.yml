version: '3.8'

services:
  # ============================================================
  # Infrastructure
  # ============================================================

  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    container_name: shopping-zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "2181:2181"
    networks:
      - shopping-net
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "2181"]
      interval: 10s
      timeout: 5s
      retries: 5

  kafka:
    image: confluentinc/cp-kafka:7.5.0
    container_name: shopping-kafka
    depends_on:
      zookeeper:
        condition: service_healthy
    ports:
      - "9092:9092"
      - "29092:29092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092,PLAINTEXT_HOST://localhost:9092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "false"
    networks:
      - shopping-net
    healthcheck:
      test: ["CMD", "kafka-broker-api-versions", "--bootstrap-server", "localhost:9092"]
      interval: 15s
      timeout: 10s
      retries: 10

  kafka-init:
    image: confluentinc/cp-kafka:7.5.0
    container_name: shopping-kafka-init
    depends_on:
      kafka:
        condition: service_healthy
    volumes:
      - ./infra/kafka/create-topics.sh:/create-topics.sh
    entrypoint: ["/bin/bash", "/create-topics.sh"]
    networks:
      - shopping-net

  redis:
    image: redis:7.2-alpine
    container_name: shopping-redis
    ports:
      - "6379:6379"
    command: redis-server --maxmemory 256mb --maxmemory-policy allkeys-lru
    networks:
      - shopping-net
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================================
  # Databases (per-service pattern)
  # ============================================================

  postgres-product:
    image: postgres:16-alpine
    container_name: shopping-postgres-product
    environment:
      POSTGRES_DB: product_db
      POSTGRES_USER: product_user
      POSTGRES_PASSWORD: product_pass
    ports:
      - "5432:5432"
    volumes:
      - postgres-product-data:/var/lib/postgresql/data
      - ./tools/seed/postgres/product-init.sql:/docker-entrypoint-initdb.d/01-init.sql
    networks:
      - shopping-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U product_user -d product_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  postgres-review:
    image: postgres:16-alpine
    container_name: shopping-postgres-review
    environment:
      POSTGRES_DB: review_db
      POSTGRES_USER: review_user
      POSTGRES_PASSWORD: review_pass
    ports:
      - "5433:5432"
    volumes:
      - postgres-review-data:/var/lib/postgresql/data
      - ./tools/seed/postgres/review-init.sql:/docker-entrypoint-initdb.d/01-init.sql
    networks:
      - shopping-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U review_user -d review_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  postgres-order:
    image: postgres:16-alpine
    container_name: shopping-postgres-order
    environment:
      POSTGRES_DB: order_db
      POSTGRES_USER: order_user
      POSTGRES_PASSWORD: order_pass
    ports:
      - "5434:5432"
    volumes:
      - postgres-order-data:/var/lib/postgresql/data
      - ./tools/seed/postgres/order-init.sql:/docker-entrypoint-initdb.d/01-init.sql
    networks:
      - shopping-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U order_user -d order_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  postgres-inventory:
    image: postgres:16-alpine
    container_name: shopping-postgres-inventory
    environment:
      POSTGRES_DB: inventory_db
      POSTGRES_USER: inventory_user
      POSTGRES_PASSWORD: inventory_pass
    ports:
      - "5435:5432"
    volumes:
      - postgres-inventory-data:/var/lib/postgresql/data
      - ./tools/seed/postgres/inventory-init.sql:/docker-entrypoint-initdb.d/01-init.sql
    networks:
      - shopping-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U inventory_user -d inventory_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  postgres-payment:
    image: postgres:16-alpine
    container_name: shopping-postgres-payment
    environment:
      POSTGRES_DB: payment_db
      POSTGRES_USER: payment_user
      POSTGRES_PASSWORD: payment_pass
    ports:
      - "5436:5432"
    volumes:
      - postgres-payment-data:/var/lib/postgresql/data
      - ./tools/seed/postgres/payment-init.sql:/docker-entrypoint-initdb.d/01-init.sql
    networks:
      - shopping-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U payment_user -d payment_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================================
  # Observability
  # ============================================================

  otel-collector:
    image: otel/opentelemetry-collector-contrib:0.91.0
    container_name: shopping-otel-collector
    command: ["--config=/etc/otel-collector.yml"]
    volumes:
      - ./infra/otel/otel-collector.yml:/etc/otel-collector.yml
    ports:
      - "4317:4317"   # OTLP gRPC
      - "4318:4318"   # OTLP HTTP
      - "8889:8889"   # Prometheus metrics
    networks:
      - shopping-net

  jaeger:
    image: jaegertracing/all-in-one:1.52
    container_name: shopping-jaeger
    environment:
      COLLECTOR_OTLP_ENABLED: "true"
    ports:
      - "16686:16686"  # Jaeger UI
      - "14268:14268"  # Jaeger collector HTTP
    networks:
      - shopping-net

  # ============================================================
  # Spring Boot Microservices
  # ============================================================

  product-service:
    build:
      context: ./services/product-service
      dockerfile: Dockerfile
    container_name: shopping-product-service
    ports:
      - "8081:8081"
    environment:
      SPRING_PROFILES_ACTIVE: docker
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres-product:5432/product_db
      SPRING_DATASOURCE_USERNAME: product_user
      SPRING_DATASOURCE_PASSWORD: product_pass
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:29092
      SPRING_DATA_REDIS_HOST: redis
      OTEL_EXPORTER_OTLP_ENDPOINT: http://otel-collector:4317
      OTEL_SERVICE_NAME: product-service
    depends_on:
      postgres-product:
        condition: service_healthy
      kafka:
        condition: service_healthy
      redis:
        condition: service_healthy
      kafka-init:
        condition: service_completed_successfully
    networks:
      - shopping-net

  review-service:
    build:
      context: ./services/review-service
      dockerfile: Dockerfile
    container_name: shopping-review-service
    ports:
      - "8082:8082"
    environment:
      SPRING_PROFILES_ACTIVE: docker
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres-review:5432/review_db
      SPRING_DATASOURCE_USERNAME: review_user
      SPRING_DATASOURCE_PASSWORD: review_pass
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:29092
      SPRING_DATA_REDIS_HOST: redis
      OTEL_EXPORTER_OTLP_ENDPOINT: http://otel-collector:4317
      OTEL_SERVICE_NAME: review-service
    depends_on:
      postgres-review:
        condition: service_healthy
      kafka:
        condition: service_healthy
      redis:
        condition: service_healthy
      kafka-init:
        condition: service_completed_successfully
    networks:
      - shopping-net

  order-service:
    build:
      context: ./services/order-service
      dockerfile: Dockerfile
    container_name: shopping-order-service
    ports:
      - "8083:8083"
    environment:
      SPRING_PROFILES_ACTIVE: docker
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres-order:5432/order_db
      SPRING_DATASOURCE_USERNAME: order_user
      SPRING_DATASOURCE_PASSWORD: order_pass
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:29092
      SPRING_DATA_REDIS_HOST: redis
      OTEL_EXPORTER_OTLP_ENDPOINT: http://otel-collector:4317
      OTEL_SERVICE_NAME: order-service
    depends_on:
      postgres-order:
        condition: service_healthy
      kafka:
        condition: service_healthy
      redis:
        condition: service_healthy
      kafka-init:
        condition: service_completed_successfully
    networks:
      - shopping-net

  inventory-service:
    build:
      context: ./services/inventory-service
      dockerfile: Dockerfile
    container_name: shopping-inventory-service
    ports:
      - "8084:8084"
    environment:
      SPRING_PROFILES_ACTIVE: docker
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres-inventory:5432/inventory_db
      SPRING_DATASOURCE_USERNAME: inventory_user
      SPRING_DATASOURCE_PASSWORD: inventory_pass
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:29092
      SPRING_DATA_REDIS_HOST: redis
      OTEL_EXPORTER_OTLP_ENDPOINT: http://otel-collector:4317
      OTEL_SERVICE_NAME: inventory-service
    depends_on:
      postgres-inventory:
        condition: service_healthy
      kafka:
        condition: service_healthy
      redis:
        condition: service_healthy
      kafka-init:
        condition: service_completed_successfully
    networks:
      - shopping-net

  payment-service:
    build:
      context: ./services/payment-service
      dockerfile: Dockerfile
    container_name: shopping-payment-service
    ports:
      - "8085:8085"
    environment:
      SPRING_PROFILES_ACTIVE: docker
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres-payment:5432/payment_db
      SPRING_DATASOURCE_USERNAME: payment_user
      SPRING_DATASOURCE_PASSWORD: payment_pass
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:29092
      SPRING_DATA_REDIS_HOST: redis
      OTEL_EXPORTER_OTLP_ENDPOINT: http://otel-collector:4317
      OTEL_SERVICE_NAME: payment-service
    depends_on:
      postgres-payment:
        condition: service_healthy
      kafka:
        condition: service_healthy
      redis:
        condition: service_healthy
      kafka-init:
        condition: service_completed_successfully
    networks:
      - shopping-net

  # ============================================================
  # Python Agent Service
  # ============================================================

  agent-service:
    build:
      context: ./agents
      dockerfile: Dockerfile
    container_name: shopping-agent-service
    ports:
      - "8000:8000"
    environment:
      OPENAI_API_KEY: ${OPENAI_API_KEY:-sk-mock-key-for-testing}
      REDIS_URL: redis://redis:6379/0
      KAFKA_BOOTSTRAP_SERVERS: kafka:29092
      PRODUCT_SERVICE_URL: http://product-service:8081
      REVIEW_SERVICE_URL: http://review-service:8082
      ORDER_SERVICE_URL: http://order-service:8083
      INVENTORY_SERVICE_URL: http://inventory-service:8084
      PAYMENT_SERVICE_URL: http://payment-service:8085
      OTEL_EXPORTER_OTLP_ENDPOINT: http://otel-collector:4317
      OTEL_SERVICE_NAME: agent-service
    depends_on:
      - product-service
      - review-service
      - order-service
      - inventory-service
      - payment-service
    networks:
      - shopping-net

networks:
  shopping-net:
    driver: bridge

volumes:
  postgres-product-data:
  postgres-review-data:
  postgres-order-data:
  postgres-inventory-data:
  postgres-payment-data:
